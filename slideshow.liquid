{%- comment -%}
- Shopify Native Section, which was updated with the ability contain images and add buy button option
- Update primarily used on the Facebook Group Product Page 
- Buy button option added upon request 
- V3: updated to fix the issue that the app Yagi created by injecting its hard code into the functionality of the website. Added AJAX functionality
to ensure that this section will remain independent from other apps in the future. 
WARNING NOTE: Please be aware of the coding implications of apps for the website's functionality. This issue only happened due to the 
choice of using Yagi. There are developer tools on all apps that explain the potential consequences of adding an app to your store.
You should familiarise yourself with them prior to adding an app to avoid a delay in service. 
{%- endcomment -%}					

{{ 'section-image-banner.css' | asset_url | stylesheet_tag }}
{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'component-slideshow.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-product-form.css' | asset_url | stylesheet_tag }}

{%- if section.settings.slide_height == 'adapt_image' and section.blocks.first.settings.image != blank -%}
  {%- style -%}
    @media screen and (max-width: 749px) {
      #Slider-{{ section.id }}::before,
      #Slider-{{ section.id }} .media::before {
        padding-bottom: {{ 1 | divided_by: section.blocks.first.settings.image.aspect_ratio | times: 100 }}%;
      }
    }
    @media screen and (min-width: 750px) {
      #Slider-{{ section.id }}::before,
      #Slider-{{ section.id }} .media::before {
        padding-bottom: {{ 1 | divided_by: section.blocks.first.settings.image.aspect_ratio | times: 100 }}%;
      }
    }
  {%- endstyle -%}
{%- endif -%}

{%- style -%}
  /* Loading Spinner Styles */
  .loading-overlay__spinner {
    width: 1.8rem;
    display: inline-block;
  }
  .spinner {
    animation: rotator 1.4s linear infinite;
  }
  @keyframes rotator {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(270deg); }
  }
  .path {
    stroke-dasharray: 280;
    stroke-dashoffset: 0;
    transform-origin: center;
    stroke: currentColor;
    animation: dash 1.4s ease-in-out infinite;
  }
  @keyframes dash {
    0% { stroke-dashoffset: 280; }
    50% { stroke-dashoffset: 75; transform: rotate(135deg); }
    100% { stroke-dashoffset: 280; transform: rotate(450deg); }
  }
  .hidden {
    display: none !important;
  }
{%- endstyle -%}

<div class="color-{{ section.settings.color_scheme }} gradient">
  <div class="section-{{ section.id }}-padding">
    {%- if section.settings.title != blank -%}
      <div class="page-width">
        <h2 class="title center {{ section.settings.heading_size }}">{{ section.settings.title }}</h2>
      </div>
    {%- endif -%}

    <slideshow-component
      class="slider-mobile-gutter{% if section.settings.layout == 'grid' %} page-width{% endif %}{% if section.settings.show_text_below %} mobile-text-below{% endif %}"
      role="region"
      aria-roledescription="{{ 'sections.slideshow.carousel' | t }}"
      aria-label="{{ section.settings.accessibility_info | escape }}"
    >
      {%- if section.blocks.size > 1 -%}
        <div class="slideshow__controls slideshow__controls--top slider-buttons{% if section.settings.show_text_below %} slideshow__controls--border-radius-mobile{% endif %}">
          <button type="button" class="slider-button slider-button--prev" name="previous" aria-label="{{ 'sections.slideshow.previous_slideshow' | t }}" aria-controls="Slider-{{ section.id }}">{% render 'icon-caret' %}</button>
          <div class="slider-counter slider-counter--{{ section.settings.slider_visual }}{% if section.settings.slider_visual == 'counter' or section.settings.slider_visual == 'numbers' %} caption{% endif %}">
            {%- if section.settings.slider_visual == 'counter' -%}
              <span class="slider-counter--current">1</span><span aria-hidden="true"> / </span><span class="visually-hidden">{{ 'general.slider.of' | t }}</span><span class="slider-counter--total">{{ section.blocks.size }}</span>
            {%- else -%}
              <div class="slideshow__control-wrapper">
                {%- for block in section.blocks -%}
                  <button class="slider-counter__link slider-counter__link--{{ section.settings.slider_visual }} link" aria-label="{{ 'sections.slideshow.load_slide' | t }} {{ forloop.index }} {{ 'general.slider.of' | t }} {{ forloop.length }}" aria-controls="Slider-{{ section.id }}">
                    {%- if section.settings.slider_visual == 'numbers' -%}{{ forloop.index }}{%- else -%}<span class="dot"></span>{%- endif -%}
                  </button>
                {%- endfor -%}
              </div>
            {%- endif -%}
          </div>
          <button type="button" class="slider-button slider-button--next" name="next" aria-label="{{ 'sections.slideshow.next_slideshow' | t }}" aria-controls="Slider-{{ section.id }}">{% render 'icon-caret' %}</button>
          {%- if section.settings.auto_rotate -%}
            <button type="button" class="slideshow__autoplay slider-button" aria-label="{{ 'sections.slideshow.pause_slideshow' | t }}">
              {%- render 'icon-pause' -%}{%- render 'icon-play' -%}
            </button>
          {%- endif -%}
        </div>
      {%- endif -%}

      <div
        class="slideshow banner banner--{{ section.settings.slide_height }} grid grid--1-col slider slider--everywhere{% if section.settings.show_text_below %} banner--mobile-bottom{% endif %}{% if section.blocks.first.settings.image == blank %} slideshow--placeholder{% endif %}"
        id="Slider-{{ section.id }}"
        aria-live="polite"
        aria-atomic="true"
        data-autoplay="{{ section.settings.auto_rotate }}"
        data-speed="{{ section.settings.change_slides_speed }}"
      >
        {%- for block in section.blocks -%}
          <style>
            #Slide-{{ section.id }}-{{ forloop.index }} .banner__media::after { opacity: {{ block.settings.image_overlay_opacity | divided_by: 100.0 }}; }
            #Slide-{{ section.id }}-{{ forloop.index }} .slideshow__media img { object-fit: {{ section.settings.image_fit | default: 'cover' }}; }
          </style>
          <div class="slideshow__slide grid__item grid--1-col slider__slide" id="Slide-{{ section.id }}-{{ forloop.index }}" {{ block.shopify_attributes }} role="group" aria-roledescription="{{ 'sections.slideshow.slide' | t }}" aria-label="{{ forloop.index }} {{ 'general.slider.of' | t }} {{ forloop.length }}" tabindex="-1">
            <div class="slideshow__media banner__media media{% if block.settings.image == blank %} placeholder{% endif %} animate--{{ section.settings.image_behavior }}">
              {%- if block.settings.image -%}
                {%- liquid
                  assign height = block.settings.image.width | divided_by: block.settings.image.aspect_ratio | round
                  assign sizes = '100vw'
                  assign widths = '375, 550, 750, 1100, 1500, 1780, 2000, 3000, 3840'
                  assign fetch_priority = 'auto'
                  if section.index == 1 and forloop.first
                    assign fetch_priority = 'high'
                  endif
                -%}
                {{ block.settings.image | image_url: width: 3840 | image_tag: loading: 'lazy', height: height, sizes: sizes, widths: widths, fetchpriority: fetch_priority }}
              {%- else -%}
                {{ 'hero-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
              {%- endif -%}
            </div>
            <div class="slideshow__text-wrapper banner__content banner__content--{{ block.settings.box_align }} page-width{% if block.settings.show_text_box == false %} banner--desktop-transparent{% endif %}">
              <div class="slideshow__text banner__box content-container color-{{ block.settings.color_scheme }} gradient slideshow__text--{{ block.settings.text_alignment }} slideshow__text-mobile--{{ block.settings.text_alignment_mobile }}">
                {%- if block.settings.heading != blank -%}<h2 class="banner__heading inline-richtext {{ block.settings.heading_size }}">{{ block.settings.heading }}</h2>{%- endif -%}
                {%- if block.settings.subheading != blank -%}<div class="banner__text rte"><p>{{ block.settings.subheading }}</p></div>{%- endif -%}
                {%- if block.settings.button_label != blank -%}
                  <div class="banner__buttons">
                    <a {% if block.settings.link %} href="{{ block.settings.link }}" {% else %} role="link" aria-disabled="true" {% endif %} class="button {% if block.settings.button_style_secondary %}button--secondary{% else %}button--primary{% endif %}">
                      {{- block.settings.button_label | escape -}}
                    </a>
                  </div>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </slideshow-component>

    {%- if section.settings.buy_button_product != blank -%}
      <div class="page-width" style="padding-top: 2rem; display: flex; justify-content: center;">
        {%- assign product = section.settings.buy_button_product -%}
        <div class="quick-add-button-wrapper">
          <button
            type="button"
            class="button button--primary js-add-to-cart"
            data-variant-id="{{ product.selected_or_first_available_variant.id }}"
            {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
          >
            <span class="js-button-text">
              {%- if product.selected_or_first_available_variant.available -%}
                {{ section.settings.buy_button_label | default: 'Add to cart' }}
              {%- else -%}
                {{ 'products.product.sold_out' | t }}
              {%- endif -%}
            </span>
            <div class="loading-overlay__spinner hidden">
              <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
              </svg>
            </div>
          </button>
        </div>
      </div>
    {%- endif -%}
  </div>
</div>

{%- if request.design_mode -%}
  <script src="{{ 'theme-editor.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Select only buttons that haven't been initialized yet to prevent double-firing
    const buttons = document.querySelectorAll('.js-add-to-cart:not(.initialized)');

    buttons.forEach(button => {
      // Mark as initialized immediately
      button.classList.add('initialized');

      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Stop event bubbling
        e.stopImmediatePropagation(); // Ensure no other listeners fire

        const variantId = this.getAttribute('data-variant-id');
        if (!variantId) return;

        // Show loading state
        this.setAttribute('disabled', true);
        this.classList.add('loading');
        const spinner = this.querySelector('.loading-overlay__spinner');
        const textSpan = this.querySelector('.js-button-text');
        
        if(spinner) spinner.classList.remove('hidden');
        if(textSpan) textSpan.classList.add('hidden');

        // Prepare form data for adding to cart
        const formData = {
          'items': [{
            'id': variantId,
            'quantity': 1
          }],
          'sections': 'cart-drawer,cart-icon-bubble' // Ask for these sections to be returned
        };

        // Fallback to /cart/add.js if window.routes isn't available
        const cartAddUrl = (window.routes && window.routes.cart_add_url) ? window.routes.cart_add_url : '/cart/add.js';

        fetch(cartAddUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
        .then(response => {
          if (!response.ok) {
             throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Check for error in response data (e.g. sold out)
          if (data.status) {
             // Only alert if it's a genuine error that prevented adding
             console.error('Cart Error:', data.description);
             alert(data.description || 'Error adding to cart');
             return;
          }

          // SUCCESS: Open the Cart Drawer
          const cartDrawer = document.querySelector('cart-drawer');
          const cartNotification = document.querySelector('cart-notification');

          if (cartDrawer) {
             // 1. Update the drawer content with the HTML returned by the API
             cartDrawer.renderContents(data);
             // 2. Add class to open the drawer
             if (cartDrawer.classList.contains('is-empty')) cartDrawer.classList.remove('is-empty');
             // Try standard methods to open
             document.body.classList.add('overflow-hidden');
             cartDrawer.classList.add('active'); // Common in Dawn
             cartDrawer.setAttribute('open', ''); // Common in newer Dawn
          } else if (cartNotification) {
             cartNotification.renderContents(data);
             cartNotification.classList.add('active');
             cartNotification.setAttribute('open', '');
          } else {
             // Fallback: Redirect to cart if no drawer found
             window.location.href = '/cart';
          }
        })
        .catch((error) => {
          console.error('Error:', error);
          // Only alert if it's a real error, not a false positive
          if (error.message && error.message !== 'Unexpected end of JSON input') {
             alert('Error adding to cart. Please try again.');
          }
        })
        .finally(() => {
          // Remove loading state
          this.removeAttribute('disabled');
          this.classList.remove('loading');
          if(spinner) spinner.classList.add('hidden');
          if(textSpan) textSpan.classList.remove('hidden');
        });
      });
    });
  });
</script>

{% schema %}
{
  "name": "t:sections.slideshow.name",
  "tag": "section",
  "class": "section",
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    {
      "type": "richtext",
      "id": "title",
      "label": "Heading"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "t:sections.all.heading_size.options__1.label" },
        { "value": "h1", "label": "t:sections.all.heading_size.options__2.label" },
        { "value": "h0", "label": "t:sections.all.heading_size.options__3.label" }
      ],
      "default": "h1",
      "label": "t:sections.all.heading_size.label"
    },
    {
      "type": "select",
      "id": "layout",
      "options": [
        { "value": "full_bleed", "label": "t:sections.slideshow.settings.layout.options__1.label" },
        { "value": "grid", "label": "t:sections.slideshow.settings.layout.options__2.label" }
      ],
      "default": "full_bleed",
      "label": "t:sections.slideshow.settings.layout.label"
    },
    {
      "type": "select",
      "id": "slide_height",
      "options": [
        { "value": "adapt_image", "label": "t:sections.slideshow.settings.slide_height.options__1.label" },
        { "value": "small", "label": "t:sections.slideshow.settings.slide_height.options__2.label" },
        { "value": "medium", "label": "t:sections.slideshow.settings.slide_height.options__3.label" },
        { "value": "large", "label": "t:sections.slideshow.settings.slide_height.options__4.label" }
      ],
      "default": "medium",
      "label": "t:sections.slideshow.settings.slide_height.label"
    },
    {
      "type": "select",
      "id": "slider_visual",
      "options": [
        { "value": "dots", "label": "t:sections.slideshow.settings.slider_visual.options__2.label" },
        { "value": "counter", "label": "t:sections.slideshow.settings.slider_visual.options__1.label" },
        { "value": "numbers", "label": "t:sections.slideshow.settings.slider_visual.options__3.label" }
      ],
      "default": "counter",
      "label": "t:sections.slideshow.settings.slider_visual.label"
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "t:sections.slideshow.settings.auto_rotate.label",
      "default": false
    },
    {
      "type": "range",
      "id": "change_slides_speed",
      "min": 3, "max": 9, "step": 2, "unit": "s",
      "label": "t:sections.slideshow.settings.change_slides_speed.label",
      "default": 5
    },
    {
      "type": "header",
      "content": "Image Fit"
    },
    {
      "type": "select",
      "id": "image_fit",
      "options": [
        { "value": "cover", "label": "t:sections.image-with-text.settings.image_fit.options__1.label" },
        { "value": "contain", "label": "t:sections.image-with-text.settings.image_fit.options__2.label" }
      ],
      "default": "cover",
      "label": "t:sections.image-with-text.settings.image_fit.label",
      "info": "t:sections.image-with-text.settings.image_fit.info"
    },
    {
      "type": "header",
      "content": "Section Buy Button"
    },
    {
      "type": "product",
      "id": "buy_button_product",
      "label": "Product"
    },
    {
      "type": "text",
      "id": "buy_button_label",
      "label": "Button label",
      "default": "Add to cart"
    },
    {
      "type": "header",
      "content": "t:sections.slideshow.settings.mobile.content"
    },
    {
      "type": "checkbox",
      "id": "show_text_below",
      "label": "t:sections.slideshow.settings.show_text_below.label",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.slideshow.settings.accessibility.content"
    },
    {
      "type": "text",
      "id": "accessibility_info",
      "label": "t:sections.slideshow.settings.accessibility.label",
      "info": "t:sections.slideshow.settings.accessibility.info",
      "default": "t:sections.slideshow.settings.accessibility.default"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "t:sections.slideshow.blocks.slide.name",
      "limit": 5,
      "settings": [
        { "type": "image_picker", "id": "image", "label": "t:sections.slideshow.blocks.slide.settings.image.label" },
        { "type": "inline_richtext", "id": "heading", "default": "t:sections.slideshow.blocks.slide.settings.heading.default", "label": "t:sections.slideshow.blocks.slide.settings.heading.label" },
        { "type": "select", "id": "heading_size", "options": [ { "value": "h2", "label": "t:sections.all.heading_size.options__1.label" }, { "value": "h1", "label": "t:sections.all.heading_size.options__2.label" }, { "value": "h0", "label": "t:sections.all.heading_size.options__3.label" } ], "default": "h1", "label": "t:sections.all.heading_size.label" },
        { "type": "inline_richtext", "id": "subheading", "default": "t:sections.slideshow.blocks.slide.settings.subheading.default", "label": "t:sections.slideshow.blocks.slide.settings.subheading.label" },
        { "type": "text", "id": "button_label", "default": "t:sections.slideshow.blocks.slide.settings.button_label.default", "label": "t:sections.slideshow.blocks.slide.settings.button_label.label", "info": "t:sections.slideshow.blocks.slide.settings.button_label.info" },
        { "type": "url", "id": "link", "label": "t:sections.slideshow.blocks.slide.settings.link.label" },
        { "type": "checkbox", "id": "button_style_secondary", "label": "t:sections.slideshow.blocks.slide.settings.secondary_style.label", "default": false },
        { "type": "select", "id": "box_align", "options": [ { "value": "top-left", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__1.label" }, { "value": "top-center", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__2.label" }, { "value": "top-right", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__3.label" }, { "value": "middle-left", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__4.label" }, { "value": "middle-center", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__5.label" }, { "value": "middle-right", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__6.label" }, { "value": "bottom-left", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__7.label" }, { "value": "bottom-center", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__8.label" }, { "value": "bottom-right", "label": "t:sections.slideshow.blocks.slide.settings.box_align.options__9.label" } ], "default": "middle-center", "label": "t:sections.slideshow.blocks.slide.settings.box_align.label", "info": "t:sections.slideshow.blocks.slide.settings.box_align.info" },
        { "type": "checkbox", "id": "show_text_box", "label": "t:sections.slideshow.blocks.slide.settings.show_text_box.label", "default": true },
        { "type": "select", "id": "text_alignment", "options": [ { "value": "left", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment.option_1.label" }, { "value": "center", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment.option_2.label" }, { "value": "right", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment.option_3.label" } ], "default": "center", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment.label" },
        { "type": "range", "id": "image_overlay_opacity", "min": 0, "max": 100, "step": 10, "unit": "%", "label": "t:sections.slideshow.blocks.slide.settings.image_overlay_opacity.label", "default": 0 },
        { "type": "color_scheme", "id": "color_scheme", "label": "t:sections.all.colors.label", "default": "scheme-1" },
        { "type": "header", "content": "t:sections.slideshow.settings.mobile.content" },
        { "type": "select", "id": "text_alignment_mobile", "options": [ { "value": "left", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment_mobile.options__1.label" }, { "value": "center", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment_mobile.options__2.label" }, { "value": "right", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment_mobile.options__3.label" } ], "default": "center", "label": "t:sections.slideshow.blocks.slide.settings.text_alignment_mobile.label" }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.slideshow.presets.name",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
