{%- comment -%}
- Shopify Native Section, which was updated with functions based on PageFly
- Code change was primarily to inject the option for the Add to Cart Button, Section Button Add to Cart, Image text overlay and border around boxes
- Added radius to corners as an option
- V8: updated to fix the issue that the app Yagi created by injecting its hard code into the functionality of the website. Added AJAX functionality
to ensure that this section will remain independent from other apps in the future. 
WARNING NOTE: Please be aware of the coding implications of apps for the website's functionality. This issue only happened due to the 
choice of using Yagi. There are developer tools on all apps that explain the potential consequences of adding an app to your store.
You should familiarise yourself with them prior to adding an app to avoid a delay in service. 
{%- endcomment -%}		


{{ 'section-multicolumn.css' | asset_url | stylesheet_tag }}
{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
  .multicolumn-card {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .multicolumn-card__info {
    flex-grow: 1;
    padding: 2.5rem;
  }
  /* Updated selector since we removed .product-form wrapper */
  .multicolumn-card .quick-add-button-wrapper,
  .multicolumn-section-buy-button {
    margin-top: 1.5rem;
  }
  .multicolumn-section-buy-button {
    display: flex;
    justify-content: center;
  }

  /* --- Styles for Text Overlay --- */
  .multicolumn-card--overlay {
    position: relative; /* Container for the text */
  }
  .multicolumn-card--overlay .multicolumn-card__image {
    opacity: 0.9; /* Darken image for readability */
  }
  .multicolumn-card--overlay .multicolumn-card__info {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 1.5rem;
    background: transparent;
    color: white;
    text-align: center;
  }
  .multicolumn-card--overlay .multicolumn-card__info * {
    color: white !important;
  }
  
  /* Loading Spinner Styles */
  .loading-overlay__spinner {
    width: 1.8rem;
    display: inline-block;
  }
  .spinner {
    animation: rotator 1.4s linear infinite;
  }
  @keyframes rotator {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(270deg); }
  }
  .path {
    stroke-dasharray: 280;
    stroke-dashoffset: 0;
    transform-origin: center;
    stroke: currentColor;
    animation: dash 1.4s ease-in-out infinite;
  }
  @keyframes dash {
    0% { stroke-dashoffset: 280; }
    50% { stroke-dashoffset: 75; transform: rotate(135deg); }
    100% { stroke-dashoffset: 280; transform: rotate(450deg); }
  }
  .hidden {
    display: none !important;
  }
{%- endstyle -%}

{%- liquid
  assign columns_mobile_int = section.settings.columns_mobile | plus: 0
  assign show_mobile_slider = false
  if section.settings.swipe_on_mobile and section.blocks.size > columns_mobile_int
    assign show_mobile_slider = true
  endif
-%}

<div class="multicolumn color-{{ section.settings.color_scheme }} gradient">
  <div
    class="page-width section-{{ section.id }}-padding isolate"
  >
    {%- unless section.settings.title == blank -%}
      <div class="title-wrapper-with-link title-wrapper--self-padded-mobile title-wrapper--no-top-margin multicolumn__title center">
        <h2 class="title inline-richtext {{ section.settings.heading_size }}">
          {{ section.settings.title }}
        </h2>
      </div>
    {%- endunless -%}
    <slider-component class="slider-mobile-gutter">
      <ul
        class="multicolumn-list contains-content-container grid grid--{{ section.settings.columns_mobile }}-col-tablet-down grid--{{ section.settings.columns_desktop }}-col-desktop{% if show_mobile_slider %} slider slider--tablet grid--peek{% endif %}"
        id="Slider-{{ section.id }}"
        role="list"
      >
        {%- liquid
          assign highest_ratio = 0
          for block in section.blocks
            if block.settings.image.aspect_ratio > highest_ratio
              assign highest_ratio = block.settings.image.aspect_ratio
            endif
          endfor
        -%}
        {%- for block in section.blocks -%}
          <li
            id="Slide-{{ section.id }}-{{ forloop.index }}"
            class="multicolumn-list__item grid__item{% if section.settings.swipe_on_mobile %} slider__slide{% endif %}{% if section.settings.column_alignment == 'center' %} center{% endif %}"
            {{ block.shopify_attributes }}
          >
            <div class="multicolumn-card content-container {% if section.settings.text_overlay %} multicolumn-card--overlay{% endif %}">
              {%- if block.settings.image != blank -%}
                <div class="multicolumn-card__image-wrapper multicolumn-card__image-wrapper--{{ section.settings.image_width }}-width">
                  <div
                    class="media media--transparent media--{{ section.settings.image_ratio }}"
                    {% if section.settings.image_ratio == 'adapt' and highest_ratio != 0 %}
                      style="padding-bottom: {{ 1 | divided_by: highest_ratio | times: 100 }}%;"
                    {% endif %}
                  >
                    {%- liquid
                      assign number_of_columns = section.settings.columns_desktop
                      assign image_width_class = section.settings.image_width
                      if image_width_class == 'full'
                         assign image_width_multiplier = 1.0
                      elsif image_width_class == 'half'
                         assign image_width_multiplier = 0.5
                      else
                         assign image_width_multiplier = 0.33
                      endif
                      assign sizes = number_of_columns | times: image_width_multiplier
                    -%}
                    {{
                      block.settings.image
                      | image_url: width: 3200
                      | image_tag:
                        widths: '50, 75, 100, 150, 200, 300, 400, 500, 750, 1000, 1250, 1500, 1750, 2000, 2250, 2500, 2750, 3000, 3200',
                        sizes: sizes,
                        class: 'multicolumn-card__image'
                    }}
                  </div>
                </div>
              {%- endif -%}

              <div class="multicolumn-card__info">
                {%- if block.settings.title != blank -%}
                  <h3 class="inline-richtext">{{ block.settings.title }}</h3>
                {%- endif -%}
                {%- if block.settings.text != blank -%}
                  <div class="rte">{{ block.settings.text }}</div>
                {%- endif -%}
                
                {%- comment -%} LINK LOGIC {%- endcomment -%}
                {%- if block.settings.link_label != blank and block.settings.product == blank -%}
                  <a class="link animate-arrow" href="{{ block.settings.link }}">
                    {{- block.settings.link_label | escape -}}
                    <span class="icon-wrap">&nbsp;{% render 'icon-arrow' %}</span>
                  </a>
                {%- endif -%}

                {%- comment -%} PRODUCT BUTTON LOGIC - REPLACED WITH DIRECT AJAX {%- endcomment -%}
                {%- if block.settings.product != blank -%}
                  {%- assign product = block.settings.product -%}
                  <div class="quick-add-button-wrapper">
                      {% comment %} 
                        DIRECT FIX: No <form> tag means no "submit" event for App to hijack.
                        We use data-variant-id to store the ID.
                      {% endcomment %}
                      <button 
                        type="button" 
                        class="button button--full-width button--primary js-add-to-cart"
                        data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                        {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
                      >
                        <span class="js-button-text">
                          {% if product.selected_or_first_available_variant.available %}
                            {{ block.settings.button_text | default: 'Add to cart' }}
                          {% else %}
                            Sold out
                          {% endif %}
                        </span>
                        <div class="loading-overlay__spinner hidden">
                          <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                            <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                          </svg>
                        </div>
                      </button>
                  </div>
                {%- endif -%}
              </div>
            </div>
          </li>
        {%- endfor -%}
      </ul>
    </slider-component>
    <div class="multicolumn-section-buy-button center">
      {%- if section.settings.section_product != blank -%}
        {%- assign product = section.settings.section_product -%}
        <div class="quick-add-button-wrapper">
            <button 
              type="button" 
              class="button button--primary js-add-to-cart"
              data-variant-id="{{ product.selected_or_first_available_variant.id }}"
              {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
            >
              <span class="js-button-text">
                {% if product.selected_or_first_available_variant.available %}
                  {{ section.settings.button_label | default: 'Add to cart' }}
                {% else %}
                  Sold out
                {% endif %}
              </span>
              <div class="loading-overlay__spinner hidden">
                <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                  <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                </svg>
              </div>
            </button>
        </div>
      {%- elsif section.settings.button_label != blank -%}
        <a class="button button--primary" href="{{ section.settings.button_link }}">
          {{ section.settings.button_label | escape }}
        </a>
      {%- endif -%}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const buttons = document.querySelectorAll('.js-add-to-cart');

    buttons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Stop event bubbling

        const variantId = this.getAttribute('data-variant-id');
        if (!variantId) return;

        // Show loading state
        this.setAttribute('disabled', true);
        this.classList.add('loading');
        const spinner = this.querySelector('.loading-overlay__spinner');
        const textSpan = this.querySelector('.js-button-text');
        
        if(spinner) spinner.classList.remove('hidden');
        if(textSpan) textSpan.classList.add('hidden');

        // Prepare form data for adding to cart
        const formData = {
          'items': [{
            'id': variantId,
            'quantity': 1
          }],
          'sections': 'cart-drawer,cart-icon-bubble' // Ask for these sections to be returned
        };

        fetch(window.Shopify.routes.root + 'cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
          // Check for error in response data (e.g. sold out)
          if (data.status) {
             alert(data.description || 'Error adding to cart');
             return;
          }

          // SUCCESS: Open the Cart Drawer
          const cartDrawer = document.querySelector('cart-drawer');
          const cartNotification = document.querySelector('cart-notification');

          if (cartDrawer) {
             // 1. Update the drawer content with the HTML returned by the API
             cartDrawer.renderContents(data);
             // 2. Add class to open the drawer
             // NOTE: Depending on theme version, this might be 'active' or attribute 'open'
             if (cartDrawer.classList.contains('is-empty')) cartDrawer.classList.remove('is-empty');
             // Try standard methods to open
             document.body.classList.add('overflow-hidden');
             cartDrawer.classList.add('active'); // Common in Dawn
             cartDrawer.setAttribute('open', ''); // Common in newer Dawn
          } else if (cartNotification) {
             cartNotification.renderContents(data);
             cartNotification.classList.add('active');
             cartNotification.setAttribute('open', '');
          } else {
             // Fallback: Redirect to cart if no drawer found
             window.location.href = '/cart';
          }
        })
        .catch((error) => {
          console.error('Error:', error);
          // Only alert if it's a real error, not a false positive syntax error from empty response
          if (error.message !== 'Unexpected end of JSON input') {
             alert('Error adding to cart. Please try again.');
          }
        })
        .finally(() => {
          // Remove loading state
          this.removeAttribute('disabled');
          this.classList.remove('loading');
          if(spinner) spinner.classList.add('hidden');
          if(textSpan) textSpan.classList.remove('hidden');
        });
      });
    });
  });
</script>

{% schema %}
{
  "name": "Multicolumn",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "inline_richtext", "id": "title", "default": "Multicolumn", "label": "Heading" },
    { "type": "select", "id": "heading_size", "options": [ { "value": "h2", "label": "Small" }, { "value": "h1", "label": "Medium" }, { "value": "h0", "label": "Large" } ], "default": "h1", "label": "Heading size" },
    { "type": "select", "id": "image_width", "options": [ { "value": "third", "label": "Third" }, { "value": "half", "label": "Half" }, { "value": "full", "label": "Full width of column" } ], "default": "full", "label": "Image width" },
    { "type": "select", "id": "image_ratio", "options": [ { "value": "adapt", "label": "Adapt to image" }, { "value": "portrait", "label": "Portrait" }, { "value": "square", "label": "Square" } ], "default": "adapt", "label": "Image ratio" },
    { "type": "range", "id": "columns_desktop", "min": 1, "max": 6, "step": 1, "default": 3, "label": "Number of columns on desktop" },
    { "type": "select", "id": "column_alignment", "options": [ { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" } ], "default": "left", "label": "Column alignment" },
    { "type": "checkbox", "id": "text_overlay", "label": "Overlay text and button on image", "default": false },
    { "type": "checkbox", "id": "enable_column_borders", "label": "Show border around each column", "default": false },
    { "type": "select", "id": "background_style", "options": [ { "value": "none", "label": "None" }, { "value": "primary", "label": "Primary" } ], "default": "primary", "label": "Secondary background" },
    { "type": "header", "content": "Section Button" },
    { "type": "product", "id": "section_product", "label": "Buy button product" },
    { "type": "text", "id": "button_label", "label": "Button label" },
    { "type": "url", "id": "button_link", "label": "Button link" },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "header", "content": "Mobile Layout" },
    { "type": "select", "id": "columns_mobile", "options": [ { "value": "1", "label": "1 column" }, { "value": "2", "label": "2 columns" } ], "default": "1", "label": "Number of columns on mobile" },
    { "type": "checkbox", "id": "swipe_on_mobile", "default": false, "label": "Enable swipe on mobile" },
    { "type": "header", "content": "Section Padding" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Top padding", "default": 36 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Bottom padding", "default": 36 }
  ],
  "blocks": [
    {
      "type": "column",
      "name": "Column",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "inline_richtext", "id": "title", "label": "Heading" },
        { "type": "richtext", "id": "text", "label": "Description" },
        { "type": "text", "id": "link_label", "label": "Link label" },
        { "type": "url", "id": "link", "label": "Link" },
        { "type": "header", "content": "Add to Cart Button" },
        { "type": "product", "id": "product", "label": "Product" },
        { "type": "text", "id": "button_text", "label": "Button text", "default": "Add to cart" }
      ]
    }
  ],
  "presets": [
    { "name": "Multicolumn", "blocks": [ { "type": "column" }, { "type": "column" }, { "type": "column" } ] }
  ]
}
{% endschema %}
